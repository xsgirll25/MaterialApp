//
//  LocalStorageManager.swift
//  MaterialOrderApp
//
//  Created by xsyoulia on 18.09.2025.
//

import Foundation
internal import Combine
internal import SwiftUI
import MessageUI


 class LocalStorageManager: ObservableObject {
    @Published var savedRequests: [MaterialRequest] = []
    
    private let userDefaults = UserDefaults.standard
    private let storageKey = "SavedMaterialRequests"
    
    init() {
        loadRequests()
    }
    
    func saveRequest(_ request: MaterialRequest) {
        savedRequests.append(request)
        saveToUserDefaults()
        objectWillChange.send()
    }
    
    func deleteRequest(at offsets: IndexSet) {
        savedRequests.remove(atOffsets: offsets)
        saveToUserDefaults()
        objectWillChange.send()
    }
    
    func saveRequests() {
        saveToUserDefaults()
        objectWillChange.send()
    }
    
    func sendEmailNotification(request: MaterialRequest,
                              onDismiss: @escaping (MFMailComposeResult) -> Void) {
        guard MFMailComposeViewController.canSendMail() else {
            let notificationText = notificationText(for: request)
            UIPasteboard.general.string = notificationText
            print("ðŸ“‹ Email Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½. Ð¢ÐµÐºÑÑ‚ ÑÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½ Ð² Ð±ÑƒÑ„ÐµÑ€.")
            return
        }
        
        _ = configureMailComposer(for: request)
        // ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°Ñ‚ÑŒ Ñ‡ÐµÑ€ÐµÐ· MailComposeView Ñ callback
        print("ðŸ“§ Email Ð³Ð¾Ñ‚Ð¾Ð² Ð´Ð»Ñ: \(request.materialName)")
    }
    
    func configureMailComposer(for request: MaterialRequest) -> MFMailComposeViewController {
        let composer = MFMailComposeViewController()
        
        composer.setSubject("âœ… Ð—Ð°ÑÐ²ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°: \(request.materialName)")
        composer.setMessageBody(notificationText(for: request), isHTML: false)
        composer.setToRecipients(["warehouse@company.com", "manager@company.com"])
        
        return composer
    }
    
    private func notificationText(for request: MaterialRequest) -> String {
        return """
        âœ… Ð—ÐÐ¯Ð’ÐšÐ Ð’Ð«ÐŸÐžÐ›ÐÐ•ÐÐ
        
        ÐœÐ°Ñ‚ÐµÑ€Ð¸Ð°Ð»: \(request.materialName)
        ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾: \(String(format: "%.1f", request.quantity)) \(request.unit)
        Ð˜ÑÐ¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒ: \(request.workerName), \(request.department)
        Ð¢Ð¸Ð¿: \(request.materialType.rawValue)
        ÐŸÑ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚: \(request.urgency.rawValue)
        Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¾: \(request.dateCompleted?.formatted(date: .abbreviated, time: .shortened) ?? "ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð¾")
        
        ---
        MaterialOrderApp
        """
    }
    
    private func loadRequests() {
        guard let data = userDefaults.data(forKey: storageKey) else { return }
        do {
            savedRequests = try JSONDecoder().decode([MaterialRequest].self, from: data)
        } catch {
            print("ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²: \(error)")
            savedRequests = []
        }
    }
    
    private func saveToUserDefaults() {
        do {
            let data = try JSONEncoder().encode(savedRequests)
            userDefaults.set(data, forKey: storageKey)
        } catch {
            print("ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²: \(error)")
        }
    }
}

// MARK: - Ð£Ð¿Ñ€Ð¾Ñ‰Ñ‘Ð½Ð½Ñ‹Ð¹ MailComposeView (Ð±ÐµÐ· NSObject Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼)
struct MailComposeView: UIViewControllerRepresentable {
    let mailComposer: MFMailComposeViewController
    
    func makeUIViewController(context: Context) -> MFMailComposeViewController {
        return mailComposer
    }
    
    func updateUIViewController(_ uiViewController: MFMailComposeViewController, context: Context) {}
}
