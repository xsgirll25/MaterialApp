//
//  NetworkManager.swift
//  MaterialOrderApp
//
//  Created by xsyoulia on 18.09.2025.
//

internal import SwiftUI
internal import Combine

struct WarehouseView: View {
    @StateObject private var warehouse = WarehouseManager()
    @State private var showingAddSheet = false
    @State private var editingItem: WarehouseItem? = nil
    
    // Фильтрация
    @State private var selectedMaterial: BuildingMaterial? = nil
    @State private var searchText = ""
    @State private var sortOption: SortOption = .byName
    
    enum SortOption: String, CaseIterable {
        case byName = "По названию"
        case byQuantity = "По количеству"
    }
    var filteredItems: [WarehouseItem] {
        var items = warehouse.items
        
        // Фильтр по типу материала
        if let filter = selectedMaterial {
            items = items.filter { $0.material == filter }
        }
        
        // Фильтр по поиску
        if !searchText.isEmpty {
            items = items.filter { $0.name.lowercased().contains(searchText.lowercased()) }
        }
        
        // Сортировка
        switch sortOption {
        case .byName:
            items.sort { $0.name < $1.name }
        case .byQuantity:
            items.sort { $0.quantity > $1.quantity }
        }
        
        return items
    }
    var body: some View {
        NavigationStack {
            List {
                ForEach(filteredItems) { item in
                    HStack {
                        VStack(alignment: .leading) {
                            Text(item.name)
                                .font(.headline)
                            Text(item.material.rawValue)
                                .font(.caption)
                                .foregroundColor(.secondary)
                        }
                        Spacer()
                        Text("\(Int(item.quantity)) \(item.unit)")
                            .font(.subheadline)
                            .bold()
                    }
                    .onTapGesture {
                        editingItem = item
                    }
                }
                .onDelete(perform: warehouse.deleteItem)
            }
            .navigationTitle("Склад")
            .sheet(item: $editingItem) { item in
                EditItemView(warehouse: warehouse, item: item)
            }
            .sheet(isPresented: $showingAddSheet) {
                AddItemView(warehouse: warehouse)
            }
            .toolbar {
                ToolbarItem(placement: .navigationBarTrailing) {
                    Button {
                        showingAddSheet = true
                    } label: {
                        Image(systemName: "plus.circle.fill")
                    }
                }
                ToolbarItem(placement: .navigationBarLeading) {
                    Menu {
                        Picker("Фильтр", selection: $selectedMaterial) {
                            Text("Все материалы").tag(BuildingMaterial?.none)
                            ForEach(BuildingMaterial.allCases, id: \.self) { mat in
                                Text(mat.rawValue).tag(BuildingMaterial?.some(mat))
                            }
                        }
                        
                        Picker("Сортировка", selection: $sortOption) {
                            ForEach(SortOption.allCases, id: \.self) { option in
                                Text(option.rawValue).tag(option)
                            }
                        }
                    } label: {
                        Image(systemName: "line.3.horizontal.decrease.circle")
                    }
                }
            }
            .searchable(text: $searchText, prompt: "Поиск по имени")
        }
    }
}
