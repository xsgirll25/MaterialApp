//
//  NetworkManager.swift
//  MaterialOrderApp
//
//  Created by xsyoulia on 18.09.2025.
//

import Foundation

@MainActor
class NetworkManager: ObservableObject {
    static let shared = NetworkManager()
    
    private let session: URLSession
    private let baseURL = "https://your-api.com/api"  // ✅ Замените на ваш
    
    private init() {
        let config = URLSessionConfiguration.default
        config.timeoutIntervalForRequest = 30
        self.session = URLSession(configuration: config)
    }
    
    // ✅ GET запрос
    func get<T: Decodable>(_ endpoint: String) async throws -> T {
        let request = createRequest(endpoint, method: "GET")
        let (data, _) = try await session.data(for: request)
        return try JSONDecoder().decode(T.self, from: data)
    }
    
    // ✅ POST запрос
    func post<T: Encodable, U: Decodable>(_ endpoint: String, body: T) async throws -> U {
        var request = createRequest(endpoint, method: "POST")
        request.httpBody = try JSONEncoder().encode(body)
        let (data, _) = try await session.data(for: request)
        return try JSONDecoder().decode(U.self, from: data)
    }
    
    // ✅ PUT запрос
    func put<T: Encodable, U: Decodable>(_ endpoint: String, body: T) async throws -> U {
        var request = createRequest(endpoint, method: "PUT")
        request.httpBody = try JSONEncoder().encode(body)
        let (data, _) = try await session.data(for: request)
        return try JSONDecoder().decode(U.self, from: data)
    }
    
    // ✅ DELETE запрос
    func delete(_ endpoint: String) async throws -> Bool {
        let request = createRequest(endpoint, method: "DELETE")
        let (_, response) = try await session.data(for: request)
        return (response as? HTTPURLResponse)?.statusCode == 200
    }
    
    // ✅ Универсальный метод создания запроса
    private func createRequest(_ endpoint: String, method: String) -> URLRequest {
        guard let url = URL(string: "\(baseURL)\(endpoint)") else {
            fatalError("Invalid URL: \(baseURL)\(endpoint)")
        }
        
        var request = URLRequest(url: url)
        request.httpMethod = method
        request.setValue("application/json", forHTTPHeaderField: "Content-Type")
        request.setValue("Bearer YOUR_TOKEN", forHTTPHeaderField: "Authorization") // если нужен токен
        
        return request
    }
}
// В NetworkManager.swift добавьте:
import UserNotifications
internal import Combine

extension NetworkManager {
    func requestNotificationPermission() {
        UNUserNotificationCenter.current().requestAuthorization(options: [.alert, .sound, .badge]) { granted, error in
            if granted {
                print("Разрешение на уведомления получено")
            }
        }
    }
    
    func sendLocalNotification(for request: MaterialRequest) {
        let content = UNMutableNotificationContent()
        content.title = "Заявка отправлена"
        content.body = "Заявка на \(request.materialName) передана в отдел снабжения"
        content.sound = .default
        
        let trigger = UNTimeIntervalNotificationTrigger(timeInterval: 1, repeats: false)
        let request = UNNotificationRequest(identifier: UUID().uuidString, content: content, trigger: trigger)
        
        UNUserNotificationCenter.current().add(request)
    }
}
