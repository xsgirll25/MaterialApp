//
//  RequestsListView.swift
//  MaterialOrderApp
//
//  Created by xsyoulia on 18.09.2025.
//

//
//  RequestsListView.swift
//  MaterialOrderApp
//
//  Created by xsyoulia on 18.09.2025.
//

internal import SwiftUI

struct DemoRequestsListView: View {
    @StateObject private var storageManager = LocalStorageManager()
    @State private var isEditing = false
    
    var body: some View {
        NavigationStack {
            List {
                ForEach(storageManager.savedRequests, id: \.id) { request in
                    NavigationLink(destination: RequestDetailView(request: request)) {
                        RequestRowView(
                            request: request,
                            isEditing: isEditing,
                            storageManager: storageManager
                        )
                    }
                    
                }
                    .onDelete(perform: deleteRequests)
            }
                .navigationTitle("–ò—Å—Ç–æ—Ä–∏—è –∑–∞—è–≤–æ–∫ (\(storageManager.savedRequests.count))")
                .toolbar {
                    Button(isEditing ? "–ì–æ—Ç–æ–≤–æ" : "–ü—Ä–∞–≤–∏—Ç—å") {
                        withAnimation {
                            isEditing.toggle()
                        }
                    }
                }
            }
        }
        
    private func deleteRequests(at offsets: IndexSet) {
            withAnimation {
                storageManager.deleteRequest(at: offsets)
            }
        }
    }
    
    struct RequestRowView: View {
        let request: MaterialRequest
        let isEditing: Bool
        let storageManager: LocalStorageManager
        @State private var selectedStatus: RequestStatus
        
        init(request: MaterialRequest, isEditing: Bool, storageManager: LocalStorageManager) {
            self.request = request
            self.isEditing = isEditing
            self.storageManager = storageManager
            _selectedStatus = State(initialValue: request.status)
        }
        
        var body: some View {
            VStack(alignment: .leading, spacing: 8) {
                HStack {
                    VStack(alignment: .leading) {
                        Text(request.materialName)
                            .font(.headline)
                        Text("\(request.workerName), \(request.department)")
                            .font(.caption)
                            .foregroundColor(.secondary)
                        Text(request.materialType.rawValue)
                            .font(.caption2)
                    }
                    Spacer()
                    Text("\(request.quantity, specifier: "%.1f") \(request.unit)")
                        .font(.headline)
                    if isEditing {
                        Image(systemName: "minus.circle.fill")
                            .foregroundColor(.red)
                    }
                }
                
                HStack {
                    Text("–°—Ç–∞—Ç—É—Å:")
                        .font(.caption)
                        .foregroundColor(.secondary)
                    if isEditing {
                        Picker("", selection: $selectedStatus) {
                            ForEach(RequestStatus.allCases, id: \.self) { status in
                                Text(status.rawValue).tag(status)
                            }
                        }
                        .pickerStyle(.segmented)
                        .font(.caption)
                    } else {
                        Text(request.status.rawValue)
                            .font(.caption)
                            .foregroundColor(statusColor(request.status))
                    }
                }
                
                HStack {
                    Text("üìÖ \(request.dateRequested.formatted(date: .abbreviated, time: .shortened))")
                        .font(.caption2)
                        .foregroundColor(.secondary)
                    Spacer()
                    Text(urgencyEmoji(request.urgency) + " " + request.urgency.rawValue)
                        .font(.caption2)
                }
            }
            .padding(.vertical, 4)
            .onChange(of: selectedStatus) { oldValue, newStatus in
                if isEditing {
                    if let index = storageManager.savedRequests.firstIndex(where: { $0.id == request.id }) {
                        var updatedRequest = request
                        updatedRequest.status = newStatus
                        
                        if newStatus == .completed {
                            updatedRequest.dateCompleted = Date()
                            // –ü—Ä–æ—Å—Ç–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ email (–ø–æ–∫–∞)
                            print("‚úÖ –ó–∞—è–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞: \(request.materialName)")
                            print("üìß –ì–æ—Ç–æ–≤–æ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ email: \(notificationText(for: updatedRequest))")
                        }
                        
                        storageManager.savedRequests[index] = updatedRequest
                        storageManager.saveRequests()
                    }
                }
            }
        }
        
        // –í—Å–µ private —Ñ—É–Ω–∫—Ü–∏–∏ –í–ù–ï body
        func statusColor(_ status: RequestStatus) -> Color {
            switch status {
            case .pending: return .orange
            case .inProgress: return .blue
            case .completed: return .green
            }
        }
        
        func urgencyEmoji(_ urgency: MaterialRequest.UrgencyLevel) -> String {
            switch urgency {
            case .low: return "üü¢"
            case .medium: return "üü°"
            case .high: return "üî¥"
            case .critical: return "üî•"
            }
        }
        
        private func notificationText(for request: MaterialRequest) -> String {
            return """
        ‚úÖ –ó–ê–Ø–í–ö–ê –í–´–ü–û–õ–ù–ï–ù–ê
        –ú–∞—Ç–µ—Ä–∏–∞–ª: \(request.materialName)
        –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å: \(request.workerName)
        """
        }
    }

